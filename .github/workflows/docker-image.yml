name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # --- 新增部分：允许手动触发 ---
  workflow_dispatch:
    inputs:
      tag:
        description: '镜像 Tag (例如: v1.0, 0623, latest)'
        required: false
        default: 'latest'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download and extract camoufox
        run: |
          wget https://github.com/daijro/camoufox/releases/download/v135.0.1-beta.24/camoufox-135.0.1-beta.24-lin.x86_64.zip
          unzip camoufox-135.0.1-beta.24-lin.x86_64.zip -d camoufox-linux
          
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        env:
          # 如果是手动触发，使用输入的 tag；如果是 push 触发，使用 'latest'
          INPUT_TAG: ${{ inputs.tag }}
        run: |
          # 1. 处理所有者名称为小写 (Docker 要求)
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          # 2. 确定 Tag
          if [ -z "$INPUT_TAG" ]; then
            IMAGE_TAG="latest"
          else
            IMAGE_TAG="$INPUT_TAG"
          fi
          
          echo "正在构建镜像: ghcr.io/$REPO_OWNER/build-server:$IMAGE_TAG"
          
          # 3. 构建
          docker build . --file Dockerfile --tag ghcr.io/$REPO_OWNER/build-server:$IMAGE_TAG
          
          # 4. 推送
          docker push ghcr.io/$REPO_OWNER/build-server:$IMAGE_TAG
